/*
 * adcarry.c
 *
 * Created: 23/11/2017 9:01:03 μμ
 * Author : kdor9
 */ 
#define F_CPU 2*10^7

#include <avr/io.h>
#include <avr/interrupt.h>

void initial();
void setupADC();
void startConversion(); 
void PWM_init();

double dutyCycle =0;

int main(void)
{
    initial();
	setupADC();
	PWM_init();
	sei();
	//TCCR0 = (1<< CS00)| (0<< CS01) | (0<<CS02);
    while (1) 
    {
    }
}
void initial()
{
	DDRD = 255;
	PORTD=255;
	TCCR0 = (1<< COM01) | (0<<COM00) | (1<<WGM00) | (1<<WGM01) | (1<<FOC0) ; //http://prntscr.com/hef4ls  http://prntscr.com/hef5e7
	TIMSK= (1<<TOIE0);
}
void setupADC()
{
	ADMUX = (0 << REFS1) | (1 << REFS0)  |  (0 << MUX0)  |  (0 << MUX1) |  (0 << MUX2) |  (0 << MUX3) | ( 0 << MUX4);//http://prntscr.com/heddod  http://prntscr.com/hedglz
	ADCSRA = (1 << ADEN) | (1 << ADIE) | (1<<ADPS2) | (1<<ADPS1) | (1<<ADPS0); //http://prntscr.com/hedt1t  http://prntscr.com/hedtkk  http://prntscr.com/hedune
	startConversion();
}
void startConversion()
{
	ADCSRA |= (1<< ADSC); // http://prntscr.com/hedt1t   https://prnt.sc/hedxkz
}
ISR(ADC_vect)
{
	dutyCycle=ADC;
	startConversion();
}
ISR(TIMER0_OVF_vect)
{
	OCR0=dutyCycle; 
}

void PWM_init()
{
	//set fast PWM mode with non-inverted output
	TCCR0 = (1<<WGM00) | (1<<WGM01) | (1<<COM01) | (1<<CS00);
	DDRB|=(1<<PB3);  //set OC0 pin as output
}
